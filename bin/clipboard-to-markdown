#!/usr/bin/env python3
import os
import sys
import subprocess
from AppKit import NSPasteboard

# Get HTML from clipboard using NSPasteboard
pasteboard = NSPasteboard.generalPasteboard()
html = pasteboard.stringForType_("public.html")

if not html:
    sys.exit(0)

# Use pandoc from $resourcePath, if set, for Platypus bundle compatibility.
pandoc_cmd = 'pandoc'
resource_path = os.environ.get('resourcePath')
if resource_path:
    bundled_pandoc = os.path.join(resource_path, 'pandoc')
    if os.path.exists(bundled_pandoc):
        pandoc_cmd = bundled_pandoc

# Convert HTML to markdown using pandoc
result = subprocess.run(
    [pandoc_cmd, '-f', 'html', '-t', 'gfm-raw_html'],
    input=html,
    capture_output=True,
    text=True
)

print(result.stdout, end='')
